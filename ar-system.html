<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AR„Éä„Éì„Ç≤„Éº„Ç∑„Éß„É≥ - Ê∏©Ê≥âÊóÖÈ§®Ôºà‰øÆÊ≠£ÁâàÔºâ</title>
    
    <!-- Meta tags -->
    <meta name="description" content="Ê∏©Ê≥âÊóÖÈ§®AR„Éä„Éì„Ç≤„Éº„Ç∑„Éß„É≥„Ç∑„Çπ„ÉÜ„É†">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    
    <style>
        /* Critical CSS */
        body {
            margin: 0;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            overflow: hidden;
            -webkit-user-select: none;
            user-select: none;
        }
        
        /* Loading Screen */
        .loading-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 2000;
            transition: opacity 0.5s ease;
        }
        
        .loading-screen.hidden {
            opacity: 0;
            pointer-events: none;
        }
        
        .loading-spinner {
            width: 60px;
            height: 60px;
            border: 4px solid rgba(255,255,255,0.2);
            border-top: 4px solid white;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 24px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .loading-text {
            font-size: 20px;
            font-weight: 600;
            margin-bottom: 12px;
            text-align: center;
        }
        
        .loading-progress {
            font-size: 16px;
            opacity: 0.8;
            text-align: center;
            max-width: 300px;
            line-height: 1.4;
        }
        
        .debug-info {
            position: fixed;
            bottom: 20px;
            left: 20px;
            right: 20px;
            background: rgba(0,0,0,0.7);
            padding: 15px;
            border-radius: 10px;
            font-size: 12px;
            max-height: 200px;
            overflow-y: auto;
            display: none;
        }
        
        .debug-info.show {
            display: block;
        }
        
        .error-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: #f44336;
            display: none;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 3000;
            padding: 20px;
            text-align: center;
        }
        
        .error-screen.show {
            display: flex;
        }
        
        .error-title {
            font-size: 24px;
            font-weight: bold;
            margin-bottom: 16px;
        }
        
        .error-message {
            font-size: 16px;
            margin-bottom: 24px;
            line-height: 1.4;
        }
        
        .error-button {
            background: white;
            color: #f44336;
            border: none;
            padding: 12px 24px;
            border-radius: 6px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            margin: 6px;
        }
        
        /* Success Screen */
        .ar-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: none;
        }
        
        .ar-container.show {
            display: block;
        }
        
        .simple-ui {
            position: fixed;
            top: 20px;
            left: 20px;
            right: 20px;
            background: rgba(0,0,0,0.7);
            padding: 15px;
            border-radius: 10px;
            z-index: 1000;
            text-align: center;
        }
        
        .nav-info {
            font-size: 18px;
            margin-bottom: 10px;
        }
        
        .distance-info {
            font-size: 16px;
            opacity: 0.8;
        }
        
        /* Debug Toggle */
        .debug-toggle {
            position: fixed;
            top: 20px;
            right: 20px;
            background: rgba(255,255,255,0.2);
            border: none;
            color: white;
            padding: 8px 12px;
            border-radius: 6px;
            font-size: 12px;
            cursor: pointer;
            z-index: 2001;
        }
    </style>
</head>
<body>
    <!-- Loading Screen -->
    <div id="loading-screen" class="loading-screen">
        <div class="loading-spinner"></div>
        <div id="loading-text" class="loading-text">AR„Ç∑„Çπ„ÉÜ„É†ÂàùÊúüÂåñ‰∏≠...</div>
        <div id="loading-progress" class="loading-progress">„Ç∑„Çπ„ÉÜ„É†„ÇíÊ∫ñÂÇô„Åó„Å¶„ÅÑ„Åæ„Åô</div>
    </div>
    
    <!-- Error Screen -->
    <div id="error-screen" class="error-screen">
        <div class="error-title">‚ö†Ô∏è ÂàùÊúüÂåñ„Ç®„É©„Éº</div>
        <div id="error-message" class="error-message">ÂïèÈ°å„ÅåÁô∫Áîü„Åó„Åæ„Åó„Åü</div>
        <button class="error-button" onclick="retryInitialization()">ÂÜçË©¶Ë°å</button>
        <button class="error-button" onclick="showSimpleMode()">Á∞°Êòì„É¢„Éº„Éâ</button>
        <button class="error-button" onclick="goHome()">„Éõ„Éº„É†„Å´Êàª„Çã</button>
    </div>
    
    <!-- AR Container -->
    <div id="ar-container" class="ar-container">
        <div class="simple-ui">
            <div class="nav-info">üß≠ AR„Éä„Éì„Ç≤„Éº„Ç∑„Éß„É≥Âãï‰Ωú‰∏≠</div>
            <div class="distance-info">ÁõÆÁöÑÂú∞„ÇíÈÅ∏Êäû„Åó„Å¶„Åè„Å†„Åï„ÅÑ</div>
        </div>
    </div>
    
    <!-- Debug Toggle -->
    <button class="debug-toggle" onclick="toggleDebug()">DEBUG</button>
    
    <!-- Debug Info -->
    <div id="debug-info" class="debug-info">
        <div id="debug-content"></div>
    </div>

    <script>
        // Debug system
        class DebugLogger {
            constructor() {
                this.logs = [];
                this.isVisible = false;
            }
            
            log(message, level = 'info') {
                const timestamp = new Date().toLocaleTimeString();
                const logEntry = `[${timestamp}] ${level.toUpperCase()}: ${message}`;
                this.logs.push(logEntry);
                console.log(logEntry);
                this.updateDebugDisplay();
            }
            
            error(message) {
                this.log(message, 'error');
            }
            
            warn(message) {
                this.log(message, 'warn');
            }
            
            info(message) {
                this.log(message, 'info');
            }
            
            updateDebugDisplay() {
                const debugContent = document.getElementById('debug-content');
                if (debugContent) {
                    debugContent.innerHTML = this.logs.slice(-10).join('<br>');
                }
            }
            
            toggle() {
                this.isVisible = !this.isVisible;
                const debugInfo = document.getElementById('debug-info');
                if (debugInfo) {
                    debugInfo.classList.toggle('show', this.isVisible);
                }
            }
        }
        
        const debugLogger = new DebugLogger();
        
        // Initialization system
        class ARInitializer {
            constructor() {
                this.initSteps = [
                    { name: '„Éñ„É©„Ç¶„Ç∂„ÉÅ„Çß„ÉÉ„ÇØ', fn: this.checkBrowser.bind(this) },
                    { name: '„Ç´„É°„É©Ê®©Èôê', fn: this.requestCameraPermission.bind(this) },
                    { name: '‰ΩçÁΩÆÊÉÖÂ†±Ê®©Èôê', fn: this.requestLocationPermission.bind(this) },
                    { name: '„Çª„É≥„Çµ„ÉºÂàùÊúüÂåñ', fn: this.initializeSensors.bind(this) },
                    { name: 'AR„É©„Ç§„Éñ„É©„É™', fn: this.loadARLibraries.bind(this) },
                    { name: 'ÂÆå‰∫Ü', fn: this.finishInitialization.bind(this) }
                ];
                this.currentStep = 0;
                this.isInitializing = false;
            }
            
            async initialize() {
                if (this.isInitializing) return;
                this.isInitializing = true;
                
                debugLogger.info('AR„Ç∑„Çπ„ÉÜ„É†ÂàùÊúüÂåñÈñãÂßã');
                
                try {
                    for (let i = 0; i < this.initSteps.length; i++) {
                        this.currentStep = i;
                        const step = this.initSteps[i];
                        
                        this.updateProgress(`${step.name}‰∏≠...`);
                        debugLogger.info(`„Çπ„ÉÜ„ÉÉ„Éó ${i + 1}/${this.initSteps.length}: ${step.name}`);
                        
                        await step.fn();
                        await this.delay(500); // UIÊõ¥Êñ∞„ÅÆ„Åü„ÇÅ„ÅÆÂæÖÊ©ü
                    }
                    
                    debugLogger.info('ÂàùÊúüÂåñÂÆå‰∫Ü');
                    this.showSuccess();
                    
                } catch (error) {
                    debugLogger.error(`ÂàùÊúüÂåñÂ§±Êïó: ${error.message}`);
                    this.showError(error.message);
                } finally {
                    this.isInitializing = false;
                }
            }
            
            async checkBrowser() {
                const userAgent = navigator.userAgent;
                debugLogger.info(`„Éñ„É©„Ç¶„Ç∂: ${userAgent}`);
                
                // iPhone Safari check
                if (!userAgent.includes('iPhone') && !userAgent.includes('iPad')) {
                    debugLogger.warn('iOS„Éá„Éê„Ç§„Çπ„Åß„ÅØ„ÅÇ„Çä„Åæ„Åõ„Çì');
                }
                
                // Required APIs check
                const requiredAPIs = [
                    'navigator.mediaDevices',
                    'navigator.geolocation',
                    'DeviceMotionEvent',
                    'DeviceOrientationEvent'
                ];
                
                for (const api of requiredAPIs) {
                    const exists = this.checkAPIExists(api);
                    debugLogger.info(`${api}: ${exists ? '„Çµ„Éù„Éº„Éà' : 'Èùû„Çµ„Éù„Éº„Éà'}`);
                }
            }
            
            checkAPIExists(apiPath) {
                const parts = apiPath.split('.');
                let obj = window;
                for (const part of parts) {
                    if (!(part in obj)) return false;
                    obj = obj[part];
                }
                return true;
            }
            
            async requestCameraPermission() {
                try {
                    if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
                        throw new Error('„Ç´„É°„É©API„Åå„Çµ„Éù„Éº„Éà„Åï„Çå„Å¶„ÅÑ„Åæ„Åõ„Çì');
                    }
                    
                    const stream = await navigator.mediaDevices.getUserMedia({ 
                        video: { 
                            facingMode: 'environment',
                            width: { ideal: 1280 },
                            height: { ideal: 720 }
                        } 
                    });
                    
                    debugLogger.info('„Ç´„É°„É©Ê®©ÈôêÂèñÂæóÊàêÂäü');
                    
                    // „Çπ„Éà„É™„Éº„É†„ÇíÂÅúÊ≠¢Ôºà„ÉÜ„Çπ„ÉàÁî®Ôºâ
                    stream.getTracks().forEach(track => track.stop());
                    
                } catch (error) {
                    if (error.name === 'NotAllowedError') {
                        throw new Error('„Ç´„É°„É©„ÅÆ‰ΩøÁî®„ÅåË®±ÂèØ„Åï„Çå„Å¶„ÅÑ„Åæ„Åõ„Çì„ÄÇË®≠ÂÆö„Åß„Ç´„É°„É©„ÇíË®±ÂèØ„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ');
                    } else if (error.name === 'NotFoundError') {
                        throw new Error('„Ç´„É°„É©„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì„ÄÇ');
                    } else {
                        throw new Error(`„Ç´„É°„É©„Ç®„É©„Éº: ${error.message}`);
                    }
                }
            }
            
            async requestLocationPermission() {
                try {
                    if (!navigator.geolocation) {
                        throw new Error('‰ΩçÁΩÆÊÉÖÂ†±API„Åå„Çµ„Éù„Éº„Éà„Åï„Çå„Å¶„ÅÑ„Åæ„Åõ„Çì');
                    }
                    
                    await new Promise((resolve, reject) => {
                        navigator.geolocation.getCurrentPosition(
                            (position) => {
                                debugLogger.info(`‰ΩçÁΩÆÊÉÖÂ†±ÂèñÂæóÊàêÂäü: ${position.coords.latitude}, ${position.coords.longitude}`);
                                resolve(position);
                            },
                            (error) => {
                                debugLogger.warn(`‰ΩçÁΩÆÊÉÖÂ†±„Ç®„É©„Éº: ${error.message}`);
                                // ‰ΩçÁΩÆÊÉÖÂ†±„ÅØÂøÖÈ†à„Åß„ÅØ„Å™„ÅÑ„ÅÆ„ÅßË≠¶Âëä„ÅÆ„Åø
                                resolve(null);
                            },
                            { timeout: 10000, enableHighAccuracy: false }
                        );
                    });
                    
                } catch (error) {
                    debugLogger.warn(`‰ΩçÁΩÆÊÉÖÂ†±ÂèñÂæóÂ§±Êïó: ${error.message}`);
                    // ‰ΩçÁΩÆÊÉÖÂ†±„Ç®„É©„Éº„ÅØËá¥ÂëΩÁöÑ„Åß„ÅØ„Å™„ÅÑ„ÅÆ„ÅßÁ∂öË°å
                }
            }
            
            async initializeSensors() {
                try {
                    // DeviceMotion permission (iOS 13+)
                    if (typeof DeviceMotionEvent.requestPermission === 'function') {
                        const permission = await DeviceMotionEvent.requestPermission();
                        if (permission !== 'granted') {
                            debugLogger.warn('„É¢„Éº„Ç∑„Éß„É≥„Çª„É≥„Çµ„ÉºÊ®©Èôê„ÅåÊãíÂê¶„Åï„Çå„Åæ„Åó„Åü');
                        } else {
                            debugLogger.info('„É¢„Éº„Ç∑„Éß„É≥„Çª„É≥„Çµ„ÉºÊ®©ÈôêÂèñÂæóÊàêÂäü');
                        }
                    }
                    
                    // DeviceOrientation permission (iOS 13+)
                    if (typeof DeviceOrientationEvent.requestPermission === 'function') {
                        const permission = await DeviceOrientationEvent.requestPermission();
                        if (permission !== 'granted') {
                            debugLogger.warn('ÊñπÂêë„Çª„É≥„Çµ„ÉºÊ®©Èôê„ÅåÊãíÂê¶„Åï„Çå„Åæ„Åó„Åü');
                        } else {
                            debugLogger.info('ÊñπÂêë„Çª„É≥„Çµ„ÉºÊ®©ÈôêÂèñÂæóÊàêÂäü');
                        }
                    }
                    
                } catch (error) {
                    debugLogger.warn(`„Çª„É≥„Çµ„ÉºÂàùÊúüÂåñË≠¶Âëä: ${error.message}`);
                    // „Çª„É≥„Çµ„Éº„Ç®„É©„Éº„ÅØËá¥ÂëΩÁöÑ„Åß„ÅØ„Å™„ÅÑ„ÅÆ„ÅßÁ∂öË°å
                }
            }
            
            async loadARLibraries() {
                try {
                    // A-Frame check (not loading for now to avoid complexity)
                    debugLogger.info('AR„É©„Ç§„Éñ„É©„É™„Çπ„Ç≠„ÉÉ„ÉóÔºàÁ∞°Êòì„É¢„Éº„ÉâÔºâ');
                    
                } catch (error) {
                    debugLogger.warn(`AR„É©„Ç§„Éñ„É©„É™„Ç®„É©„Éº: ${error.message}`);
                    // „É©„Ç§„Éñ„É©„É™„Ç®„É©„Éº„ÇÇËá¥ÂëΩÁöÑ„Åß„ÅØ„Å™„ÅÑ„ÅÆ„ÅßÁ∂öË°å
                }
            }
            
            async finishInitialization() {
                debugLogger.info('ÂàùÊúüÂåñÂá¶ÁêÜÂÆå‰∫Ü');
            }
            
            updateProgress(message) {
                const progressEl = document.getElementById('loading-progress');
                if (progressEl) {
                    progressEl.textContent = message;
                }
            }
            
            showSuccess() {
                const loadingScreen = document.getElementById('loading-screen');
                const arContainer = document.getElementById('ar-container');
                
                if (loadingScreen) {
                    loadingScreen.classList.add('hidden');
                }
                
                if (arContainer) {
                    arContainer.classList.add('show');
                }
            }
            
            showError(message) {
                const loadingScreen = document.getElementById('loading-screen');
                const errorScreen = document.getElementById('error-screen');
                const errorMessage = document.getElementById('error-message');
                
                if (loadingScreen) {
                    loadingScreen.classList.add('hidden');
                }
                
                if (errorScreen) {
                    errorScreen.classList.add('show');
                }
                
                if (errorMessage) {
                    errorMessage.textContent = message;
                }
            }
            
            delay(ms) {
                return new Promise(resolve => setTimeout(resolve, ms));
            }
        }
        
        // Global functions
        let arInitializer = null;
        
        function toggleDebug() {
            debugLogger.toggle();
        }
        
        function retryInitialization() {
            const errorScreen = document.getElementById('error-screen');
            const loadingScreen = document.getElementById('loading-screen');
            
            if (errorScreen) errorScreen.classList.remove('show');
            if (loadingScreen) loadingScreen.classList.remove('hidden');
            
            if (arInitializer) {
                arInitializer.initialize();
            }
        }
        
        function showSimpleMode() {
            const errorScreen = document.getElementById('error-screen');
            const arContainer = document.getElementById('ar-container');
            
            if (errorScreen) errorScreen.classList.remove('show');
            if (arContainer) arContainer.classList.add('show');
            
            debugLogger.info('Á∞°Êòì„É¢„Éº„Éâ„ÅßËµ∑Âãï');
        }
        
        function goHome() {
            window.location.href = 'index.html';
        }
        
        // Initialize on load
        document.addEventListener('DOMContentLoaded', function() {
            debugLogger.info('DOMContentLoaded');
            
            arInitializer = new ARInitializer();
            
            // 1ÁßíÂæå„Å´ÂàùÊúüÂåñÈñãÂßãÔºàUIÊ∫ñÂÇô„ÅÆ„Åü„ÇÅÔºâ
            setTimeout(() => {
                arInitializer.initialize();
            }, 1000);
        });
        
        // Error handling
        window.addEventListener('error', function(event) {
            debugLogger.error(`JS Error: ${event.error?.message || event.message}`);
        });
        
        window.addEventListener('unhandledrejection', function(event) {
            debugLogger.error(`Promise Error: ${event.reason}`);
        });
    </script>
</body>
</html>
