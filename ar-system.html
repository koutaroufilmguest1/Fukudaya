<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Èï∑Â¥éÁúåÊ∏©Ê≥âÊóÖÈ§®WebAR„Éä„Éì„Ç≤„Éº„Ç∑„Éß„É≥ - Á£ÅÊ∞ó„Ç≥„É≥„Éë„ÇπÊ†°Ê≠£Áâà</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css">
    <script src="https://aframe.io/releases/1.4.0/aframe.min.js"></script>
    <script src="https://cdn.jsdelivr.net/gh/AR-js-org/AR.js@3.4.5/aframe/build/aframe-ar.min.js"></script>
    <style>
        :root {
            --primary-color: #2563eb;
            --secondary-color: #10b981;
            --accent-color: #f59e0b;
            --danger-color: #ef4444;
            --success-color: #22c55e;
            --warning-color: #f59e0b;
            --info-color: #3b82f6;
            --dark-bg: #1f2937;
            --glass-bg: rgba(255, 255, 255, 0.1);
            --glass-border: rgba(255, 255, 255, 0.2);
        }

        body {
            margin: 0;
            padding: 0;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            overflow-x: hidden;
        }

        .glass-effect {
            background: var(--glass-bg);
            backdrop-filter: blur(10px);
            border: 1px solid var(--glass-border);
            border-radius: 16px;
            box-shadow: 0 8px 32px rgba(31, 38, 135, 0.37);
        }

        .compass {
            width: 200px;
            height: 200px;
            border-radius: 50%;
            position: relative;
            margin: 20px auto;
            background: conic-gradient(from 0deg, #ff6b6b, #4ecdc4, #45b7d1, #96ceb4, #feca57, #ff9ff3, #54a0ff, #5f27cd);
            box-shadow: 0 0 30px rgba(0,0,0,0.3);
        }

        .compass-inner {
            width: 180px;
            height: 180px;
            background: #2c3e50;
            border-radius: 50%;
            position: absolute;
            top: 10px;
            left: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .compass-needle {
            width: 4px;
            height: 80px;
            background: linear-gradient(to top, #e74c3c 0%, #e74c3c 45%, #ecf0f1 55%, #ecf0f1 100%);
            position: absolute;
            top: 50px;
            left: 98px;
            transform-origin: center bottom;
            border-radius: 2px;
            transition: transform 0.3s ease;
            box-shadow: 0 0 10px rgba(231, 76, 60, 0.6);
        }

        .compass-center {
            width: 12px;
            height: 12px;
            background: #34495e;
            border-radius: 50%;
            position: absolute;
            top: 94px;
            left: 94px;
            z-index: 10;
            box-shadow: inset 0 2px 4px rgba(0,0,0,0.3);
        }

        .compass-directions {
            position: absolute;
            width: 100%;
            height: 100%;
            color: white;
            font-weight: bold;
            font-size: 18px;
        }

        .direction-n { position: absolute; top: 5px; left: 50%; transform: translateX(-50%); }
        .direction-e { position: absolute; right: 8px; top: 50%; transform: translateY(-50%); }
        .direction-s { position: absolute; bottom: 5px; left: 50%; transform: translateX(-50%); }
        .direction-w { position: absolute; left: 8px; top: 50%; transform: translateY(-50%); }

        .direction-arrow {
            width: 0;
            height: 0;
            border-left: 15px solid transparent;
            border-right: 15px solid transparent;
            border-bottom: 40px solid #e74c3c;
            position: absolute;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            transform-origin: center 40px;
            transition: transform 0.3s ease;
            filter: drop-shadow(0 0 8px rgba(231, 76, 60, 0.8));
        }

        .accuracy-indicator {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: bold;
            margin: 5px;
        }

        .accuracy-good { background: var(--success-color); color: white; }
        .accuracy-fair { background: var(--warning-color); color: white; }
        .accuracy-poor { background: var(--danger-color); color: white; }

        .calibration-guide {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.8);
            z-index: 1000;
            backdrop-filter: blur(5px);
        }

        .calibration-content {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            padding: 30px;
            border-radius: 20px;
            text-align: center;
            max-width: 90%;
            width: 400px;
        }

        .figure-eight {
            width: 100px;
            height: 100px;
            margin: 20px auto;
            position: relative;
        }

        .figure-eight::before,
        .figure-eight::after {
            content: '';
            position: absolute;
            width: 40px;
            height: 40px;
            border: 3px solid var(--primary-color);
            border-radius: 50%;
        }

        .figure-eight::before {
            top: 0;
            left: 10px;
            animation: rotate-top 2s infinite;
        }

        .figure-eight::after {
            bottom: 0;
            right: 10px;
            animation: rotate-bottom 2s infinite;
        }

        @keyframes rotate-top {
            0%, 100% { transform: rotate(0deg); }
            50% { transform: rotate(180deg); }
        }

        @keyframes rotate-bottom {
            0%, 100% { transform: rotate(180deg); }
            50% { transform: rotate(0deg); }
        }

        .sensor-debug {
            background: rgba(0,0,0,0.8);
            color: white;
            padding: 10px;
            border-radius: 8px;
            font-family: monospace;
            font-size: 12px;
            margin: 10px 0;
            display: none;
        }

        .control-panel {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 100;
        }

        .nav-button {
            background: var(--glass-bg);
            backdrop-filter: blur(10px);
            border: 1px solid var(--glass-border);
            color: white;
            padding: 12px 24px;
            border-radius: 25px;
            margin: 5px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 600;
        }

        .nav-button:hover {
            background: rgba(255, 255, 255, 0.2);
            transform: translateY(-2px);
        }

        .destination-selection {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.9);
            z-index: 500;
            backdrop-filter: blur(10px);
        }

        .destination-content {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            padding: 30px;
            border-radius: 20px;
            max-width: 90%;
            width: 500px;
        }

        .destination-item {
            display: flex;
            align-items: center;
            padding: 15px;
            margin: 10px 0;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.3s ease;
            border: 2px solid #e5e7eb;
        }

        .destination-item:hover {
            background: #f3f4f6;
            border-color: var(--primary-color);
            transform: translateX(5px);
        }

        .ar-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 1;
        }

        .ar-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 10;
        }

        .status-panel {
            position: absolute;
            top: 20px;
            left: 20px;
            right: 20px;
            background: rgba(0,0,0,0.7);
            color: white;
            padding: 15px;
            border-radius: 12px;
            pointer-events: auto;
        }

        .pulse {
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }

        .magnetic-declination-info {
            background: var(--info-color);
            color: white;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 12px;
            margin: 5px 0;
            display: inline-block;
        }

        .hidden { display: none !important; }
        .visible { display: block !important; }
    </style>
</head>
<body>
    <!-- „É°„Ç§„É≥„Ç§„É≥„Çø„Éº„Éï„Çß„Éº„Çπ -->
    <div id="mainInterface" class="min-h-screen flex flex-col items-center justify-center p-4">
        <div class="glass-effect p-8 max-w-md w-full text-center text-white">
            <h1 class="text-2xl font-bold mb-2">üè® Èï∑Â¥éÁúåÊ∏©Ê≥âÊóÖÈ§®</h1>
            <h2 class="text-lg mb-6">WebAR„Éä„Éì„Ç≤„Éº„Ç∑„Éß„É≥„Ç∑„Çπ„ÉÜ„É†</h2>
            
            <!-- Á£ÅÊ∞óÂÅèÂ∑ÆÊÉÖÂ†± -->
            <div class="magnetic-declination-info">
                <i class="fas fa-compass"></i> Èï∑Â¥éÁúåÁ£ÅÊ∞óÂÅèÂ∑Æ: -6.9¬∞
            </div>
            
            <!-- „Ç≥„É≥„Éë„ÇπË°®Á§∫ -->
            <div class="compass">
                <div class="compass-inner">
                    <div class="compass-directions">
                        <div class="direction-n">N</div>
                        <div class="direction-e">E</div>
                        <div class="direction-s">S</div>
                        <div class="direction-w">W</div>
                    </div>
                    <div class="compass-needle" id="compassNeedle"></div>
                    <div class="compass-center"></div>
                </div>
            </div>
            
            <!-- ÊñπÂêëÁü¢Âç∞ -->
            <div style="position: relative; height: 100px; margin: 20px 0;">
                <div class="direction-arrow" id="directionArrow"></div>
            </div>
            
            <!-- Á≤æÂ∫¶„Ç§„É≥„Ç∏„Ç±„Éº„Çø„Éº -->
            <div class="mb-4">
                <div class="accuracy-indicator accuracy-poor" id="accuracyIndicator">Ê†°Ê≠£‰∏≠...</div>
            </div>
            
            <!-- „Çª„É≥„Çµ„ÉºÊÉÖÂ†±Ôºà„Éá„Éê„ÉÉ„Ç∞„É¢„Éº„ÉâÔºâ -->
            <div class="sensor-debug" id="sensorDebug">
                <div>ÊñπÂêë: <span id="orientationValue">-</span>¬∞</div>
                <div>Á£ÅÊ∞óÂÅèÂ∑ÆË£úÊ≠£Âæå: <span id="correctedValue">-</span>¬∞</div>
                <div>Ê†°Ê≠£Áä∂ÊÖã: <span id="calibrationStatus">Êú™Ê†°Ê≠£</span></div>
            </div>
            
            <!-- „Ç≥„É≥„Éà„É≠„Éº„É´„Éú„Çø„É≥ -->
            <div class="space-y-3">
                <button id="startNavigation" class="nav-button w-full">
                    <i class="fas fa-route"></i> „Éä„Éì„Ç≤„Éº„Ç∑„Éß„É≥ÈñãÂßã
                </button>
                <button id="calibrateCompass" class="nav-button w-full">
                    <i class="fas fa-compass"></i> „Ç≥„É≥„Éë„ÇπÊ†°Ê≠£
                </button>
                <button id="toggleDebug" class="nav-button w-full">
                    <i class="fas fa-bug"></i> „Éá„Éê„ÉÉ„Ç∞„É¢„Éº„Éâ
                </button>
            </div>
        </div>
    </div>

    <!-- Ê†°Ê≠£„Ç¨„Ç§„Éâ -->
    <div id="calibrationGuide" class="calibration-guide">
        <div class="calibration-content">
            <h3 class="text-xl font-bold mb-4">„Ç≥„É≥„Éë„ÇπÊ†°Ê≠£</h3>
            <p class="mb-4">Ê≠£Á¢∫„Å™ÊñπÂêë„ÇíÂèñÂæó„Åô„Çã„Åü„ÇÅ„ÄÅ„Éá„Éê„Ç§„Çπ„Çí‰ª•‰∏ã„ÅÆ„Çà„ÅÜ„Å´Âãï„Åã„Åó„Å¶„Åè„Å†„Åï„ÅÑÔºö</p>
            
            <div class="figure-eight"></div>
            
            <p class="text-sm text-gray-600 mb-6">
                „Éá„Éê„Ç§„Çπ„Çí8„ÅÆÂ≠ó„Å´3Âõû„ÇÜ„Å£„Åè„Çä„Å®Âãï„Åã„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ<br>
                Á£ÅÊ∞ó„Çª„É≥„Çµ„Éº„ÅåÂë®Âõ≤„ÅÆÁ£ÅÂ†¥„ÇíÂ≠¶Áøí„Åó„Åæ„Åô„ÄÇ
            </p>
            
            <div class="space-y-3">
                <button id="startCalibration" class="nav-button">
                    <i class="fas fa-play"></i> Ê†°Ê≠£ÈñãÂßã
                </button>
                <button id="skipCalibration" class="nav-button">
                    <i class="fas fa-skip-forward"></i> „Çπ„Ç≠„ÉÉ„Éó
                </button>
            </div>
        </div>
    </div>

    <!-- ÁõÆÁöÑÂú∞ÈÅ∏Êäû -->
    <div id="destinationSelection" class="destination-selection">
        <div class="destination-content">
            <h3 class="text-xl font-bold mb-6">ÁõÆÁöÑÂú∞„ÇíÈÅ∏Êäû„Åó„Å¶„Åè„Å†„Åï„ÅÑ</h3>
            
            <div class="destination-item" data-destination="lobby">
                <i class="fas fa-home text-2xl mr-4 text-blue-500"></i>
                <div>
                    <div class="font-bold">„É≠„Éì„Éº</div>
                    <div class="text-sm text-gray-600">„Ç®„É≥„Éà„É©„É≥„Çπ„Åã„ÇâÁ¥Ñ20mÂåó</div>
                </div>
            </div>
            
            <div class="destination-item" data-destination="onsen">
                <i class="fas fa-hot-tub text-2xl mr-4 text-red-500"></i>
                <div>
                    <div class="font-bold">Ê∏©Ê≥âÂ§ßÊµ¥Â†¥</div>
                    <div class="text-sm text-gray-600">„Ç®„É≥„Éà„É©„É≥„Çπ„Åã„ÇâÁ¥Ñ40mÂåó</div>
                </div>
            </div>
            
            <div class="destination-item" data-destination="restaurant">
                <i class="fas fa-utensils text-2xl mr-4 text-green-500"></i>
                <div>
                    <div class="font-bold">„É¨„Çπ„Éà„É©„É≥</div>
                    <div class="text-sm text-gray-600">„Ç®„É≥„Éà„É©„É≥„Çπ„Åã„ÇâÁ¥Ñ40mÂåóÊù±</div>
                </div>
            </div>
            
            <div class="destination-item" data-destination="elevator">
                <i class="fas fa-elevator text-2xl mr-4 text-purple-500"></i>
                <div>
                    <div class="font-bold">„Ç®„É¨„Éô„Éº„Çø„Éº</div>
                    <div class="text-sm text-gray-600">ÂÆ¢ÂÆ§„Ç®„É™„Ç¢„Å∏Ôºà2Èöé‰ª•‰∏äÔºâ</div>
                </div>
            </div>
            
            <button id="closeDestination" class="nav-button w-full mt-4">
                <i class="fas fa-times"></i> „Ç≠„É£„É≥„Çª„É´
            </button>
        </div>
    </div>

    <!-- ARË°®Á§∫„Ç®„É™„Ç¢ -->
    <div id="arContainer" class="ar-container hidden">
        <a-scene 
            vr-mode-ui="enabled: false" 
            renderer="logarithmicDepthBuffer: true;" 
            arjs="trackingMethod: best; sourceType: webcam; debugUIEnabled: false;"
            id="arScene">
            
            <a-camera id="arCamera" gps-camera rotation-reader></a-camera>
            
            <!-- 3DÁü¢Âç∞ -->
            <a-cone 
                id="navigationArrow"
                position="0 0 -5" 
                rotation="-90 0 0" 
                radius-bottom="0.5" 
                radius-top="0" 
                height="2" 
                color="#e74c3c"
                animation__rotate="property: rotation; to: -90 360 0; loop: true; dur: 3000">
            </a-cone>
            
            <!-- ÁõÆÁöÑÂú∞„Éû„Éº„Ç´„Éº -->
            <a-sphere 
                id="destinationMarker"
                position="0 2 -10" 
                radius="0.5" 
                color="#22c55e"
                animation__pulse="property: scale; to: 1.2 1.2 1.2; loop: true; dir: alternate; dur: 1000">
            </a-sphere>
            
            <!-- „ÉÜ„Ç≠„Çπ„ÉàË°®Á§∫ -->
            <a-text 
                id="navigationText"
                value="ÁõÆÁöÑÂú∞„Å∏„ÅÆÊñπÂêë" 
                position="0 3 -10" 
                align="center" 
                color="#ffffff"
                geometry="primitive: plane; width: auto; height: auto"
                material="color: rgba(0,0,0,0.7)">
            </a-text>
        </a-scene>
        
        <!-- AR „Ç™„Éº„Éê„Éº„É¨„Ç§ -->
        <div class="ar-overlay">
            <div class="status-panel">
                <div class="flex justify-between items-center mb-2">
                    <span id="currentDestination">ÁõÆÁöÑÂú∞: Êú™ÈÅ∏Êäû</span>
                    <button id="exitAR" class="nav-button">
                        <i class="fas fa-times"></i> ÁµÇ‰∫Ü
                    </button>
                </div>
                <div class="text-sm">
                    <span>Ë∑ùÈõ¢: <span id="distanceDisplay">Ë®àÁÆó‰∏≠...</span></span>
                    <span class="ml-4">Á≤æÂ∫¶: <span id="arAccuracy" class="accuracy-indicator accuracy-fair">Fair</span></span>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Èï∑Â¥éÁúåÊ∏©Ê≥âÊóÖÈ§®WebAR„Éä„Éì„Ç≤„Éº„Ç∑„Éß„É≥„Ç∑„Çπ„ÉÜ„É†
        class NagasakiOnsenARNavigation {
            constructor() {
                // Èï∑Â¥éÁúå„ÅÆÁ£ÅÊ∞óÂÅèÂ∑ÆÂÄ§Ôºà-6.9Â∫¶Ôºâ
                this.MAGNETIC_DECLINATION = -6.9;
                
                // Â∫ßÊ®ôË®≠ÂÆö
                this.INN_LOCATION = {
                    lat: 32.76656645690299,
                    lng: 129.8575246988253
                };
                
                this.ENTRANCE_LOCATION = {
                    lat: 32.76629645690299,
                    lng: 129.8575246988253
                };
                
                // ÁõÆÁöÑÂú∞ÂÆöÁæ©Ôºà„Ç®„É≥„Éà„É©„É≥„ÇπÂü∫Ê∫ñÔºâ
                this.destinations = {
                    lobby: { name: '„É≠„Éì„Éº', distance: 20, bearing: 0, floor: 1 },
                    onsen: { name: 'Ê∏©Ê≥âÂ§ßÊµ¥Â†¥', distance: 40, bearing: 0, floor: 1 },
                    restaurant: { name: '„É¨„Çπ„Éà„É©„É≥', distance: 40, bearing: 45, floor: 1 },
                    elevator: { name: '„Ç®„É¨„Éô„Éº„Çø„Éº', distance: 15, bearing: 90, floor: 1 }
                };
                
                this.currentDestination = null;
                this.deviceOrientation = 0;
                this.isCalibrated = false;
                this.calibrationOffset = 0;
                this.debugMode = false;
                this.arActive = false;
                
                this.init();
            }
            
            init() {
                this.setupEventListeners();
                this.requestSensorPermissions();
                this.showCalibrationIfNeeded();
            }
            
            setupEventListeners() {
                // „É°„Ç§„É≥„Éú„Çø„É≥
                document.getElementById('startNavigation').addEventListener('click', () => {
                    this.showDestinationSelection();
                });
                
                document.getElementById('calibrateCompass').addEventListener('click', () => {
                    this.showCalibrationGuide();
                });
                
                document.getElementById('toggleDebug').addEventListener('click', () => {
                    this.toggleDebugMode();
                });
                
                // Ê†°Ê≠£Èñ¢ÈÄ£
                document.getElementById('startCalibration').addEventListener('click', () => {
                    this.startCalibration();
                });
                
                document.getElementById('skipCalibration').addEventListener('click', () => {
                    this.hideCalibrationGuide();
                });
                
                // ÁõÆÁöÑÂú∞ÈÅ∏Êäû
                document.querySelectorAll('.destination-item').forEach(item => {
                    item.addEventListener('click', () => {
                        const destination = item.dataset.destination;
                        this.selectDestination(destination);
                    });
                });
                
                document.getElementById('closeDestination').addEventListener('click', () => {
                    this.hideDestinationSelection();
                });
                
                // ARÁµÇ‰∫Ü
                document.getElementById('exitAR').addEventListener('click', () => {
                    this.exitAR();
                });
            }
            
            async requestSensorPermissions() {
                try {
                    if (typeof DeviceOrientationEvent.requestPermission === 'function') {
                        const permission = await DeviceOrientationEvent.requestPermission();
                        if (permission === 'granted') {
                            this.startOrientationTracking();
                        }
                    } else {
                        this.startOrientationTracking();
                    }
                } catch (error) {
                    console.error('„Çª„É≥„Çµ„ÉºÊ®©Èôê„ÅÆÂèñÂæó„Å´Â§±Êïó:', error);
                    this.showError('„Çª„É≥„Çµ„Éº„Å∏„ÅÆ„Ç¢„ÇØ„Çª„Çπ„ÅåË®±ÂèØ„Åï„Çå„Å¶„ÅÑ„Åæ„Åõ„Çì');
                }
            }
            
            startOrientationTracking() {
                if (window.DeviceOrientationEvent) {
                    window.addEventListener('deviceorientation', (event) => {
                        this.handleDeviceOrientation(event);
                    });
                } else {
                    this.showError('„Éá„Éê„Ç§„Çπ„ÅÆÊñπÂêë„Çª„É≥„Çµ„Éº„Åå„Çµ„Éù„Éº„Éà„Åï„Çå„Å¶„ÅÑ„Åæ„Åõ„Çì');
                }
            }
            
            handleDeviceOrientation(event) {
                let heading = event.alpha;
                if (heading !== null) {
                    // Èï∑Â¥éÁúå„ÅÆÁ£ÅÊ∞óÂÅèÂ∑ÆË£úÊ≠£„ÇíÈÅ©Áî®
                    heading = (heading + 360) % 360;
                    const correctedHeading = (heading + this.MAGNETIC_DECLINATION + this.calibrationOffset + 360) % 360;
                    
                    this.deviceOrientation = correctedHeading;
                    this.updateCompass(correctedHeading);
                    this.updateDirectionArrow(correctedHeading);
                    this.updateAccuracyIndicator();
                    
                    if (this.debugMode) {
                        this.updateDebugInfo(heading, correctedHeading);
                    }
                    
                    if (this.arActive) {
                        this.updateARNavigation(correctedHeading);
                    }
                }
            }
            
            updateCompass(heading) {
                const needle = document.getElementById('compassNeedle');
                if (needle) {
                    needle.style.transform = `rotate(${heading}deg)`;
                }
            }
            
            updateDirectionArrow(heading) {
                const arrow = document.getElementById('directionArrow');
                if (arrow) {
                    arrow.style.transform = `translateX(-50%) rotate(${heading}deg)`;
                }
            }
            
            updateAccuracyIndicator() {
                const indicator = document.getElementById('accuracyIndicator');
                if (!indicator) return;
                
                let accuracy = 'poor';
                let text = 'Ê†°Ê≠£„ÅåÂøÖË¶Å';
                
                if (this.isCalibrated) {
                    accuracy = 'good';
                    text = 'Á≤æÂ∫¶ËâØÂ•Ω';
                } else if (Math.abs(this.deviceOrientation) > 0) {
                    accuracy = 'fair';
                    text = '‰ΩøÁî®ÂèØËÉΩ';
                }
                
                indicator.className = `accuracy-indicator accuracy-${accuracy}`;
                indicator.textContent = text;
            }
            
            updateDebugInfo(rawHeading, correctedHeading) {
                document.getElementById('orientationValue').textContent = rawHeading.toFixed(1);
                document.getElementById('correctedValue').textContent = correctedHeading.toFixed(1);
                document.getElementById('calibrationStatus').textContent = this.isCalibrated ? 'Ê†°Ê≠£Ê∏à„Åø' : 'Êú™Ê†°Ê≠£';
            }
            
            showCalibrationIfNeeded() {
                if (!this.isCalibrated) {
                    setTimeout(() => {
                        this.showCalibrationGuide();
                    }, 2000);
                }
            }
            
            showCalibrationGuide() {
                document.getElementById('calibrationGuide').style.display = 'flex';
            }
            
            hideCalibrationGuide() {
                document.getElementById('calibrationGuide').style.display = 'none';
            }
            
            startCalibration() {
                this.hideCalibrationGuide();
                
                // Ê†°Ê≠£„Éó„É≠„Çª„Çπ„ÅÆÈñãÂßã
                let calibrationData = [];
                let calibrationCount = 0;
                const maxCalibrations = 8;
                
                const calibrationInterval = setInterval(() => {
                    if (calibrationCount >= maxCalibrations) {
                        clearInterval(calibrationInterval);
                        this.completeCalibration(calibrationData);
                        return;
                    }
                    
                    calibrationData.push(this.deviceOrientation);
                    calibrationCount++;
                    
                    // Ê†°Ê≠£ÈÄ≤Êçó„ÅÆË°®Á§∫
                    const indicator = document.getElementById('accuracyIndicator');
                    indicator.textContent = `Ê†°Ê≠£‰∏≠... ${calibrationCount}/${maxCalibrations}`;
                    
                }, 500);
            }
            
            completeCalibration(calibrationData) {
                // Ê†°Ê≠£„Éá„Éº„Çø„Åã„ÇâÊúÄÈÅ©„Å™„Ç™„Éï„Çª„ÉÉ„Éà„ÇíË®àÁÆó
                const averageHeading = calibrationData.reduce((sum, heading) => sum + heading, 0) / calibrationData.length;
                
                // ÂåóÂêë„Åç„ÇíÂü∫Ê∫ñ„Å®„Åó„ÅüË£úÊ≠£ÂÄ§„ÇíË®àÁÆó
                this.calibrationOffset = -averageHeading;
                this.isCalibrated = true;
                
                this.showSuccess('„Ç≥„É≥„Éë„Çπ„ÅÆÊ†°Ê≠£„ÅåÂÆå‰∫Ü„Åó„Åæ„Åó„ÅüÔºÅ');
                this.updateAccuracyIndicator();
            }
            
            showDestinationSelection() {
                document.getElementById('destinationSelection').style.display = 'flex';
            }
            
            hideDestinationSelection() {
                document.getElementById('destinationSelection').style.display = 'none';
            }
            
            selectDestination(destinationKey) {
                this.currentDestination = destinationKey;
                this.hideDestinationSelection();
                this.startAR();
            }
            
            async startAR() {
                try {
                    // „Ç´„É°„É©„Ç¢„ÇØ„Çª„ÇπË®±ÂèØ„ÇíË¶ÅÊ±Ç
                    const stream = await navigator.mediaDevices.getUserMedia({ 
                        video: { facingMode: 'environment' } 
                    });
                    
                    // „É°„Ç§„É≥„Ç§„É≥„Çø„Éº„Éï„Çß„Éº„Çπ„ÇíÈùûË°®Á§∫
                    document.getElementById('mainInterface').classList.add('hidden');
                    
                    // AR„Ç≥„É≥„ÉÜ„Éä„ÇíË°®Á§∫
                    document.getElementById('arContainer').classList.remove('hidden');
                    
                    this.arActive = true;
                    this.setupARScene();
                    
                } catch (error) {
                    console.error('AR„ÅÆÈñãÂßã„Å´Â§±Êïó:', error);
                    this.showError('„Ç´„É°„É©„Å∏„ÅÆ„Ç¢„ÇØ„Çª„Çπ„ÅåË®±ÂèØ„Åï„Çå„Å¶„ÅÑ„Åæ„Åõ„Çì');
                }
            }
            
            setupARScene() {
                const destination = this.destinations[this.currentDestination];
                if (!destination) return;
                
                // ÁõÆÁöÑÂú∞ÊÉÖÂ†±„ÇíÊõ¥Êñ∞
                document.getElementById('currentDestination').textContent = `ÁõÆÁöÑÂú∞: ${destination.name}`;
                
                // ARË¶ÅÁ¥†„ÅÆÂàùÊúüÂåñ
                this.updateARNavigation(this.deviceOrientation);
            }
            
            updateARNavigation(currentHeading) {
                if (!this.currentDestination) return;
                
                const destination = this.destinations[this.currentDestination];
                const targetBearing = destination.bearing;
                
                // ÊñπÂêëÂ∑Æ„ÇíË®àÁÆó
                let directionDiff = targetBearing - currentHeading;
                if (directionDiff > 180) directionDiff -= 360;
                if (directionDiff < -180) directionDiff += 360;
                
                // 3DÁü¢Âç∞„ÅÆÂõûËª¢„ÇíÊõ¥Êñ∞
                const arrow = document.getElementById('navigationArrow');
                if (arrow) {
                    arrow.setAttribute('rotation', `-90 0 ${directionDiff}`);
                }
                
                // Ë∑ùÈõ¢Ë°®Á§∫„ÇíÊõ¥Êñ∞
                document.getElementById('distanceDisplay').textContent = `Á¥Ñ${destination.distance}m`;
                
                // Á≤æÂ∫¶Ë°®Á§∫„ÇíÊõ¥Êñ∞
                const arAccuracy = document.getElementById('arAccuracy');
                if (Math.abs(directionDiff) < 10) {
                    arAccuracy.className = 'accuracy-indicator accuracy-good';
                    arAccuracy.textContent = 'Good';
                } else if (Math.abs(directionDiff) < 30) {
                    arAccuracy.className = 'accuracy-indicator accuracy-fair';
                    arAccuracy.textContent = 'Fair';
                } else {
                    arAccuracy.className = 'accuracy-indicator accuracy-poor';
                    arAccuracy.textContent = 'Poor';
                }
            }
            
            exitAR() {
                this.arActive = false;
                this.currentDestination = null;
                
                // AR„Ç≥„É≥„ÉÜ„Éä„ÇíÈùûË°®Á§∫
                document.getElementById('arContainer').classList.add('hidden');
                
                // „É°„Ç§„É≥„Ç§„É≥„Çø„Éº„Éï„Çß„Éº„Çπ„ÇíË°®Á§∫
                document.getElementById('mainInterface').classList.remove('hidden');
            }
            
            toggleDebugMode() {
                this.debugMode = !this.debugMode;
                const debugPanel = document.getElementById('sensorDebug');
                
                if (this.debugMode) {
                    debugPanel.style.display = 'block';
                } else {
                    debugPanel.style.display = 'none';
                }
            }
            
            showSuccess(message) {
                // Á∞°Âçò„Å™ÊàêÂäü„É°„ÉÉ„Çª„Éº„Ç∏Ë°®Á§∫
                alert(message);
            }
            
            showError(message) {
                // Á∞°Âçò„Å™„Ç®„É©„Éº„É°„ÉÉ„Çª„Éº„Ç∏Ë°®Á§∫
                alert('„Ç®„É©„Éº: ' + message);
            }
        }
        
        // „Ç∑„Çπ„ÉÜ„É†ÂàùÊúüÂåñ
        document.addEventListener('DOMContentLoaded', () => {
            new NagasakiOnsenARNavigation();
        });
    </script>
</body>
</html>
